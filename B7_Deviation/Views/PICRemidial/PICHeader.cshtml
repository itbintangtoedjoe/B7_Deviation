
@{
	ViewBag.Title = "PICHeader";
	Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-body">
	<div class="form-group">
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<div class="card">
						<div class="card-body">

							<div class="form-group">
								<h4 class="d-inline">Laporan Penyimpangan / Potensi Penyimpangan</h4>
							</div>

							<div class="form-group row">
								<div class="col-md-8">
									<div class="form-group">

										<button type="button" id="btnSave" class="col-sm-2 btn mb-1 btn-success form-control ">
											Save
											<span class="fa fa-check-square-o"></span>
										</button>

									</div>

									<div class="form-group" id="xddlx" hidden="hidden">
										<div class="col">
											<label class="col col-form-label">Reviewer<span class="text-danger">*</span> :</label>
										</div>
										<div class="col">
											<div class="col input-group form-group">
												<div class="basic-dropdown">
													<div class="dropdown user-dropdown form-inline">
														<select id="ddlReviewer" name="ddlReviewer" class="form-control">
														</select>
													</div>
												</div>
												<span id="spanUser" class="input-group-append" title="Tambah orang terlibat">
													<span class="input-group-text btn-success">
														<i class="fa fa-user-plus"></i>
													</span>
												</span>
											</div>
											<div class="col form-group">
												<table id="tblWho" class="table table-striped table-bordered">
													<thead>
														<tr>
															<th style="width:20px">No</th>
															<th>Nama</th>
															<th>NIK</th>
															<th style="width:30px">Action</th>
														</tr>
													</thead>
													<tbody id="tblBodyWho">
													</tbody>
												</table>
											</div>
										</div>

									</div>
								</div>

								<div class="col-md-4">
									<div class="form-group">
										<label>Nama</label>
										<input id="xdxdxdxd" type="text" class="form-control" readonly="readonly" value="@Request.RequestContext.HttpContext.Session["fullname"]">
									</div>
									<div class="form-group">
										<label for="txtTanggal">Tanggal:</label>
										<input class="form-control" readonly="readonly" value="@System.DateTime.Now.ToString("dd-MM-yyyy")" />
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>

	<div class="form-group">

		@Html.Partial("~/Views/QualityManager/QualityManagerPartialView.cshtml")

	</div>

	<div class="form-group">
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<div class="card">
						<div class="card-body">
							<div class="form-group row">
								<div class="col-md-12">
									<div class="form-group">
										<label for="usulantindakan">
											Usulan Tindakan Remedial
										</label>
										<textarea id="usulantindakan" class="form-control" disabled="disabled"></textarea>
									</div>

									<div class="form-group">
										<label for="usulantindakan">
											Disposisi Tindakan Remedial
										</label>
										<textarea id="disposisitindakan" class="form-control" disabled="disabled"></textarea>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="form-group">
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<div class="card">

						<div class="card-body">

							<div class="form-group row">
								<label class="col-sm-2 col-form-label">Hasil Tindakan Remedial<span class="text-danger">*</span></label>
								<div class="col-sm-10 input-group">
									<textarea id="txtHasilTindakan" class="form-control" style="width: 960px;"></textarea>
								</div>
							</div>

							<div class="form-group row" id="can">
								<label class="col-sm-2 col-form-label">Upload Bukti Tindakan Remidial<span class="text-danger">*</span></label>
								<div class="col-sm-7">
									<div class="input-group">

										@using (Html.BeginForm("Index", "PICRemidial", FormMethod.Post, new { enctype = "multipart/form-data" }))
										{
											<input type="file" name="NamaFileUpload" id="idFileUploadAttach" style="padding-top:10px; width:400px;" />
											<button type="button" id="spanBukti" class="col-sm-2 btn mb-1 btn-success ">Upload</button>
										}
									</div>
									<div class="col-sm-12" style="margin-top : 10px; margin-left : -15px">
										<table id="tblBukti" class="table table-striped table-bordered">
											<thead>
												<tr>
													<th style="width:20px">No</th>
													<th>Bukti Tindakan Remidial</th>
													<th style="width:30px">Action</th>
												</tr>
											</thead>
											<tbody id="tblBuktiBody">
											</tbody>
										</table>
									</div>
								</div>
							</div>

                            <div class="form-group">
                                <div class="form-group">
                                    <h5 class="d-inline">Adakah biaya dalam tindakan Remidial?</h5>
									<br />
                                    <div class="form-check form-check-inline">
                                        <div class="form-check form-check-inline">
                                            <label>
                                                <input type="radio" name="checkhiddencost" id="flexRadioDefault1" value="Yes"> Ada Biaya
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <label>
                                                <input type="radio" name="checkhiddencost" id="flexRadioDefault2" value="No" checked> Tidak Ada Biaya
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

							<hr />
							<div id="picsubmission" hidden="hidden">
								
                                <div class="form-group">
									<div class="row form-group">
										<label class="d-inline" style="color:red;font-weight:bold">Note: Minimal satu group cost wajib diisi</label>
									</div>
                                </div>
								<div class="form-group">
									<div class="row form-group">
										<h4 class="d-inline">Testing Cost</h4>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Durasi Pengerjaan (Jam)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="testingDurasiPengerjaan" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Jumlah Pelaksana (Orang)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="testingJumlahPelaksana" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Manhours Value (Rp)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="testingManhoursValue" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Cost of Analysis (Rp)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="testingCostAnalysis" />
										</div>
									</div>
								</div>

								<div class="form-group">
									<div class="row form-group">
										<h4 class="d-inline">Processing</h4>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Durasi Pengerjaan (Jam)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="procDurasiPengerjaan" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Jumlah Pelaksana (Orang)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="procJumlahPelaksana" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Manhours Value (Rp)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="procManhoursValue" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Material/Product</label>
										<div class="col-sm-10">
											<input type="text" class="form-control" id="procMaterial" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Quantity</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="procQty" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Cost Material (Rp)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="procCostMaterial" />
										</div>
									</div>
								</div>

								<div class="form-group">
									<div class="row form-group">
										<h4 class="d-inline">Rejected</h4>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Material/Product</label>
										<div class="col-sm-10">
											<input type="text" class="form-control" id="rejMaterial" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Quantity</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="rejQty" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Cost Material (Rp)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="rejCostMaterial" />
										</div>
									</div>
								</div>

								<div class="form-group">
									<div class="row form-group">
										<h4 class="d-inline">Machine Cost</h4>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Durasi Pengerjaan (Jam)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="mcDurasiPengerjaan" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Jumlah Teknisi (Orang)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="mcJumlahTeknisi" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Manhours Value (Rp)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="mcManhoursValue" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Nama Mesin</label>
										<div class="col-sm-10">
											<input type="text" class="form-control" id="mcNamaMesin" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Total Machine Hours Value (Rp)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="mcTotalMachineHours" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Sparepart/Service</label>
										<div class="col-sm-10">
											<input type="text" class="form-control" id="mcSparepart" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-2 col-form-label">Harga Sparepart (Rp)</label>
										<div class="col-sm-10">
											<input type="text" name="currency-field" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$" value="" data-type="currency" class="form-control" id="mcHargaSparepart" />
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script nonce="8kSaHI8GrbxtyEWnJFzJ8g==">

	var CheckDelete = 0;

	$(document).ready(function () {
		$(window).bind('beforeunload', function () {
			if (CheckDelete = 0) {
				BeforeUnload();
			}

			return '';
		});
	});

	$(document).ready(function () {
		LoadBukti();
		GetUsulanTindakan();
		LoadCost();

        $("input[name=checkhiddencost]").change(function () {
            CheckHiddenCostType();
		});


		$("#btnSave").click(function () {
			Save();
		});

		$('#spanBukti').click(function () {
			InsertBukti();
		});


        $("input[data-type='currency']").on({
			keyup: function () {

                formatCurrency($(this));
            },
            blur: function () {
                formatCurrency($(this), "blur");
            }
        });

	});



	function CheckHiddenCostType() {
        var x = $('input[name="checkhiddencost"]:checked').val();
		if (x == 'Yes') {
			$("#picsubmission").removeAttr("hidden");
		} else {
			$("#picsubmission").attr("hidden", true);

            // Testing Section
            $("#testingDurasiPengerjaan").val('');
            $("#testingJumlahPelaksana").val('');
            $("#testingManhoursValue").val('');
            $("#testingCostAnalysis").val('');

            // Processing Section
            $("#procDurasiPengerjaan").val('');
            $("#procJumlahPelaksana").val('');
            $("#procManhoursValue").val('');
            $("#procMaterial").val('');
            $("#procQty").val('');
            $("#procCostMaterial").val('');

            // Rejection Section
            $("#rejMaterial").val('');
            $("#rejQty").val('');
            $("#rejCostMaterial").val('');

            // Machine Cost
            $("#mcDurasiPengerjaan").val('');
            $("#mcJumlahTeknisi").val('');
            $("#mcManhoursValue").val('');
            $("#mcNamaMesin").val('');
            $("#mcTotalMachineHours").val('');
            $("#mcSparepart").val('');
            $("#mcHargaSparepart").val('');
        }
	}

	function GetUsulanTindakan() {
		var REQID = @ViewBag.nomor;
		var urutan = @ViewBag.urutan;


		var iduser = '@Request.RequestContext.HttpContext.Session["xUser"]';

		var dto = {
			REQID: REQID

		};

		$.ajax({
			url: "../QualityManager/QM_GetUsulanTindakan",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {

				document.getElementById('usulantindakan').value = data[0].USULAN_REMIDIAL;

			}, error: function (ex) {
                ErrorPIC("QM_GetUsulanTindakan", JSON.stringify(ex));
			}
		});


		var dtx = {
			LOGIN_USER: iduser,
			REQID: REQID,
            NO_DISPOSISI: urutan
		};
		$.ajax({
			url: "../QualityManager/QM_GetDisposisiTindakan",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dtx),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
                $('#disposisitindakan').val(data[0].DISPOSISI_TINDAKAN);
                $('#txtHasilTindakan').val(data[0].HASIL_TINDAKAN);
                var adaCost = data[0].HIDDEN_COST_TYPE;
				$("input[name=checkhiddencost][value=" + adaCost + "]").prop('checked', true);
				if (adaCost == 'Yes') {
					$("#picsubmission").prop('hidden', false);
				}

                $('textarea').each(function () {
                    //this.setAttribute('style', 'height: ' + (this.scrollHeight) + 'px;width:500px;overflow-y:hidden;');
                    this.setAttribute('style', 'height: ' + (this.scrollHeight) + 'px;overflow-y:hidden;');
                }).on('input', function () {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
			}, error: function (ex) {
                ErrorPIC("QM_GetDisposisiTindakan", JSON.stringify(ex));
			}
		});
	}

	function LoadCost() {
		var REQID = @ViewBag.nomor;
		var urutan = @ViewBag.urutan;
		var iduser = '@Request.RequestContext.HttpContext.Session["xUser"]';

		var dto = {
			REQID: REQID,
			NO_DISPOSISI:urutan
		};

		$.ajax({
            url: "../QualityManager/LoadCostDisposisi",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
                // Testing Section
				$("#testingDurasiPengerjaan").val(data[0].TESTING_DURASI_PENGERJAAN);
				$("#testingJumlahPelaksana").val(data[0].TESTING_JUMLAH_PELAKSANA);
				$("#testingManhoursValue").val(data[0].TESTING_MANHOURS_VALUE);
				$("#testingCostAnalysis").val(data[0].TESTING_COST_OF_ANALYSIS);

				// Processing Section
				$("#procDurasiPengerjaan").val(data[0].PROC_DURASI_PENGERJAAN);
				$("#procJumlahPelaksana").val(data[0].PROC_JUMLAH_PELAKSANA);
				$("#procManhoursValue").val(data[0].PROC_MANHOURS_VALUE);
                $("#procMaterial").val(data[0].PROC_MATERIAL);
				$("#procQty").val(data[0].PROC_QUANTITY);
				$("#procCostMaterial").val(data[0].PROC_COST_MATERIAL);

				// Rejection Section
                $("#rejMaterial").val(data[0].REJ_MATERIAL);
				$("#rejQty").val(data[0].REJ_QUANTITY);
				$("#rejCostMaterial").val(data[0].REJ_COST_MATERIAL);

				// Machine Cost
				$("#mcDurasiPengerjaan").val(data[0].MC_DURASI_PENGERJAAN);
				$("#mcJumlahTeknisi").val(data[0].MC_JUMLAH_TEKNISI);
				$("#mcManhoursValue").val(data[0].MC_MANHOURS_VALUE);
                $("#mcNamaMesin").val(data[0].MC_NAMA_MESIN);
				$("#mcTotalMachineHours").val(data[0].MC_TOTAL_MACHINE_HOURS_VALUE);
				$("#mcSparepart").val(data[0].MC_SPAREPART);
				$("#mcHargaSparepart").val(data[0].MC_TOTAL_HARGA_SPAREPART);
			}, error: function (ex) {
                ErrorPIC("LoadCostDisposisi", JSON.stringify(ex));
			}
		});
	}

	function BeforeUnload() {
		var reqid = $("#lblReq").text();
		var iduser = '@Request.RequestContext.HttpContext.Session["xUser"]';

		var dto = {
			LOGIN_USER: iduser,
			REQID: reqid
		};

		$.ajax({
			url: "../Reviewer/Reviewer_DeletePath",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
			}
			, error: function (ex) {
                ErrorPIC("Reviewer_DeletePath", stringify(ex));
			}
		});

		$.ajax({
			url: "../Reviewer/Reviewer_DeleteFile",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
			}
			, error: function (ex) {
                ErrorPIC("Reviewer_DeleteFile" , stringify(ex));
			}
		});
	}

	function InsertBukti() {

		var formData = new FormData();
		var REQID = @ViewBag.nomor;
		var totalFiles = document.getElementById("idFileUploadAttach").files.length;
		var usernik = '@Request.RequestContext.HttpContext.Session["xUser"]';
		var urutan = @ViewBag.urutan;

		for (var i = 0; i < totalFiles; i++) {
			var file = document.getElementById("idFileUploadAttach").files[i];
			formData.append("idFileUploadAttach", file);
			formData.append("ReqID", REQID);
			formData.append("UserNIK", usernik);
			formData.append("NoDisposisi", urutan);
		}

		$.ajax({
			type: "POST",
			url: "../PICRemidial/PIC_InsertBukti",
			data: formData,
			dataType: "json",
			contentType: false,
			processData: false,
			JsonRequestBehavior: true,
			success: function (data) {

				if (data == 'S') {
                    $('#idFileUploadAttach').val('');

                    CheckDelete = 1;
					toastr.success("Bukti berhasil tersimpan !", "Tersimpan", {
						"closeButton": false,
						"debug": true,
						"newestOnTop": false,
						"progressBar": false,
						"positionClass": "toast-top-right",
						"preventDuplicates": false,
						"onclick": null,
						"showDuration": "100",
						"hideDuration": "1000",
						"timeOut": "2000",
						"extendedTimeOut": "1000",
						"showEasing": "swing",
						"hideEasing": "linear",
						"showMethod": "fadeIn",
						"hideMethod": "fadeOut"
					});

					LoadBukti();
				}
			}
			, error: function (ex) {
                ErrorPIC('Error Delete Attachment', JSON.stringify(ex));
			}
		});
	}

	function LoadBukti() {

		var REQID = @ViewBag.nomor;
        var urutan = @ViewBag.urutan;

		var USERNIK = '@Request.RequestContext.HttpContext.Session["xUser"]';

		var dto = {
			ReqId: REQID,
			USERNIK: USERNIK,
            NO_DISPOSISI: urutan
		}

		$.ajax({
			url: "../PICRemidial/PIC_LoadBukti",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {

				if (data != '') {

					var trHTML = '';
					var trav = 0;
					var Count = data.length;

                    if (Count > 0) {
						for (trav = 0; trav < Count; trav++) {
							var no = 1
							no = no + trav
							trHTML += '<tr><td>' + no + '</td>' +
								'<td style="display:none">' + data[trav].REQ_ID + '</td>' +
								'<td style="display:none">' + data[trav].NO_BUKTI + '</td>' +
								'<td>' + data[trav].FILE_NAME_UPLOAD + '</td>' +
								'<td style="display:none;">' + data[trav].PATH_FILE + '</td>' +
								'<td><button onclick = "DeleteFileAttachment(this)"  class="btn btn-danger" title="Delete" ><span class="fa fa-trash-o"><strong></strong></span></button></td></tr>';
						}

						$("#tblBukti").attr('hidden', false);
                        $("#tblBuktiBody").empty();
                        $("#tblBuktiBody").append(trHTML);
                        $("#tblBuktiBody").addBack();
					} else {
                        $("#tblBukti").addBack();
						$("#tblBukti").attr('hidden', true);
                    }
				}
				else {
                    $("#tblBukti").attr('hidden', true);
				}

			}
			, error: function (ex) {
                ErrorPIC('Error Load User Involved' , JSON.stringify(ex));
			}
		});
	}

	function Save() {

		var REQID = @ViewBag.nomor;
		var iduser = '@Request.RequestContext.HttpContext.Session["xUser"]';
		var urutan = @ViewBag.urutan;

		// Detailed Section
        var HiddenCostType = $('input[name="checkhiddencost"]:checked').val();
		var HasilTindakan = $("#txtHasilTindakan").val();

		// Testing Section
        var testDP = $("#testingDurasiPengerjaan").val().replaceAll(',', '');
        var testJP = $("#testingJumlahPelaksana").val().replaceAll(',', '');
        var testMV = $("#testingManhoursValue").val().replaceAll(',', '');
        var testCA = $("#testingCostAnalysis").val().replaceAll(',', '');

		// Processing Section
        var procDP = $("#procDurasiPengerjaan").val().replaceAll(',', '');
        var procJP = $("#procJumlahPelaksana").val().replaceAll(',', '');
        var procMV = $("#procManhoursValue").val().replaceAll(',', '');
		var procM = $("#procMaterial").val();
        var procQ = $("#procQty").val().replaceAll(',', '');
        var procCM = $("#procCostMaterial").val().replaceAll(',', '');

		// Rejection Section
		var rejM = $("#rejMaterial").val();
        var rejQ = $("#rejQty").val().replaceAll(',', '');
        var rejCM = $("#rejCostMaterial").val().replaceAll(',', '');

		// Machine Cost
        var mcDP = $("#mcDurasiPengerjaan").val().replaceAll(',', '');
        var mcJT = $("#mcJumlahTeknisi").val().replaceAll(',', '');
        var mcMV = $("#mcManhoursValue").val().replaceAll(',', '');
		var mcNM = $("#mcNamaMesin").val();
        var mcMH = $("#mcTotalMachineHours").val().replaceAll(',', '');
        var mcS = $("#mcSparepart").val().replaceAll(',', '');
        var mcHS = $("#mcHargaSparepart").val().replaceAll(',', '');


		if (HiddenCostType == 'Yes') {
			if (HasilTindakan == '') {
				Swal.fire({
					icon: 'error',
					title: 'Oops...',
					text: 'Hasil Tindakan Remidial harus diisi!',
				})
				return;
			}
			else if (testMV == '' && testCA == '' && procMV == '' && procCM == '' && rejCM == '' && mcMV == '' && mcS == '' && mcHS == '') {
				Swal.fire({
					icon: 'error',
					title: 'Oops...',
					text: 'Salah satu group cost wajib diisi!',
				})
				return;
			}
			else if (procDP != '' || procJP != '' || procMV != '') {
				if (procDP == '' || procJP == '' || procMV == '') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Processing Cost wajib diisi semua!',
                    })
                    return;
				}
			}
            else if (testDP != '' || testJP != '' || testMV != '') {
                if (testDP == '' || testJP == '' || testMV == '') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Testing Cost wajib diisi semua!',
                    })
                    return;
                }
            }
		}
		else {
            if (HasilTindakan == '') {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Hasil Tindakan Remidial harus diisi!',
                })
                return;
            }
		}


		var dto = {
			REQID: REQID,
			IDUSER: iduser,
			NO_DISPOSISI: urutan,

			HasilTindakan: HasilTindakan,
			HiddenCostType: HiddenCostType,
			testDP: testDP,
			testJP: testJP,
			testMV: testMV,
			testCA: testCA,
			procDP: procDP,
			procJP: procJP,
			procMV: procMV,
			procM: procM,
			procQ: procQ,
			procCM: procCM,
			rejM: rejM,
			rejQ: rejQ,
			rejCM: rejCM,
			mcDP: mcDP,
			mcJT: mcJT,
			mcMV: mcMV,
			mcNM: mcNM,
			mcMH: mcMH,
			mcS: mcS,
			mcHS: mcHS
		};

		$.ajax({
			url: "../PICRemidial/PIC_Save",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				CheckDelete = 1;

				Swal.fire({
					title: 'Form Submit',
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 2000
				}).then(() => {

					function SendEmailPIC() {
						//jika pakai cost kirim email ke superior
						if (HiddenCostType == 'Yes') {

							var receiver = '@Request.RequestContext.HttpContext.Session["xUser"]';
							var tabletype = "One";
							var whoreceiver = "Superior PIC after PIC Submit Cost";

							var dtx = {
								Receiver: receiver,
								ReqID: REQID,
								TableType: tabletype,
								WhoReceiver: whoreceiver
							};

							$.ajax({
								type: "post",
								url: '../Form/SendEmailInputProposal',
								data: JSON.stringify(dtx),
								dataType: "json",
								contentType: "application/json;charset=utf-8",
								success: function (data) {
                                    toastr.success("Email Sent Successfully !", "Notification", {
                                        "closeButton": false,
                                        "debug": true,
                                        "newestOnTop": false,
                                        "progressBar": false,
                                        "positionClass": "toast-bottom-right",
                                        "preventDuplicates": false,
                                        "onclick": null,
                                        "showDuration": "200",
                                        "hideDuration": "1000",
                                        "timeOut": "2000",
                                        "extendedTimeOut": "1000",
                                        "showEasing": "swing",
                                        "hideEasing": "linear",
                                        "showMethod": "fadeIn",
                                        "hideMethod": "fadeOut"
                                    });
								}, error: function (ex) {
									ErrorPIC("Error Email: " + JSON.stringify(ex));
								}
							});
						}

						//tanpa cost kirim email ke koordinator
						else {
							var receiver = '@Request.RequestContext.HttpContext.Session["xUser"]';
							var tabletype = "More Than One";
							var whoreceiver = "Koordinator after PIC Submit";

							var dtx = {
								Receiver: receiver,
								ReqID: REQID,
								TableType: tabletype,
								WhoReceiver: whoreceiver
							};

							$.ajax({
								type: "post",
								url: '../Form/SendEmailInputProposal',
								data: JSON.stringify(dtx),
								dataType: "json",
								contentType: "application/json;charset=utf-8",
								success: function (data) {
                                    toastr.success("Email Sent Successfully !", "Notification", {
                                        "closeButton": false,
                                        "debug": true,
                                        "newestOnTop": false,
                                        "progressBar": false,
                                        "positionClass": "toast-bottom-right",
                                        "preventDuplicates": false,
                                        "onclick": null,
                                        "showDuration": "200",
                                        "hideDuration": "1000",
                                        "timeOut": "2000",
                                        "extendedTimeOut": "1000",
                                        "showEasing": "swing",
                                        "hideEasing": "linear",
                                        "showMethod": "fadeIn",
                                        "hideMethod": "fadeOut"
                                    });
								}, error: function (ex) {
									ErrorPIC("Error Email: " + JSON.stringify(ex));
								}
							});
						}
					}

                    $.when(SendEmailPIC()).done(window.location.href = "../DataDeviasi/PendingTask");
				});

			}
			, error: function (ex) {
                ErrorPIC('Error Save', JSON.stringify(ex));
			}
		});


	}

	function DeleteFileAttachment(button) {
		var Row = $(button).closest("TR");
		var ReqID = $("TD", Row).eq(1).html();
		var RecordID = $("TD", Row).eq(2).html();
		var FileName = $("TD", Row).eq(3).html();
		var PathFile = $("TD", Row).eq(4).html();
		var urutan = @ViewBag.urutan;

		var usernik = '@Request.RequestContext.HttpContext.Session["xUser"]';

		var dto = {
			ReqID: ReqID,
			RecordID: RecordID,
			PathFile: PathFile,
			USERNIK: usernik,
            NO_DISPOSISI: urutan
		}

		$.ajax({
            url: "../PICRemidial/PIC_DeleteAttachment",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				if (data == 'S') {

					toastr.success("File Attachment " + FileName + " Berhasil dihapus", "Berhasil", {
						"closeButton": false,
						"debug": true,
						"newestOnTop": false,
						"progressBar": false,
						"positionClass": "toast-top-left",
						"preventDuplicates": false,
						"onclick": null,
						"showDuration": "100",
						"hideDuration": "1000",
						"timeOut": "2000",
						"extendedTimeOut": "1000",
						"showEasing": "swing",
						"hideEasing": "linear",
						"showMethod": "fadeIn",
						"hideMethod": "fadeOut"
					});

					LoadBukti();
				}
			},
			error: function (ex) {
                ErrorPIC("Delete AtachmentPIC", JSON.stringify(ex));
			}
		});

	}

	function ErrorPIC(ErrorType, ErrorMsg) {
		var REQID = @ViewBag.nomor;
		var USERNIK = '@Request.RequestContext.HttpContext.Session["xUser"]';

		var dto = {
			REQ_ID: REQID,
			UserLogin: USERNIK,
            ErrorType: ErrorType,
            ErrorMsg: ErrorMsg
		}

		$.ajax({
			url: "../Form/LogError",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
                toastr.warning(data +" Failure ! ", "Notification", {
                    "closeButton": false,
                    "debug": true,
                    "newestOnTop": false,
                    "progressBar": false,
                    "positionClass": "toast-bottom-right",
                    "preventDuplicates": false,
                    "onclick": null,
                    "showDuration": "200",
                    "hideDuration": "1000",
                    "timeOut": "2000",
                    "extendedTimeOut": "1000",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut"
                });
			}
			, error: function (ex) {

			}
		});
	}
</script>

