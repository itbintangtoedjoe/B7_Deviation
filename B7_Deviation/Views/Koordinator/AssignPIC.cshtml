
@{
	ViewBag.Title = "AssignPIC";
	Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/Styles/css/jquery.dataTables.min.css" rel="stylesheet" />
<script src="~/Content/Styles/js/jquery.dataTables.min.js" defer nonce="W2zGwzd0AYQO10/Y0HEhkA=="></script>

<body>
	<div class="content-body">
		<div class="form-group">
			<div class="container-fluid">
				
				<div class="card">
					<div class="card-body">
						<div class="form-group">
							<h2 class="d-inline">Assign PIC</h2>
						</div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover verticle-middle table-responsive" id="datatablepic" style="color:black" width="1250px">
                                <thead>
                                    <tr>
                                        <th style="text-align:center">No</th>
                                        <th width="700px" style="text-align:center">Keterangan Disposisi</th>
                                        <th width="200px" style="text-align:center">Pelaksana</th>
                                        <th wdith="100px" style="text-align:center">Due Date</th>
                                        <th width="150px" style="text-align:center">Actions</th>
                                        <th hidden="hidden">No Disposisi</th>
                                    </tr>
                                </thead>
                                <tbody id="pictable">
                                </tbody>
                            </table>
                        </div>                        
						<br />
						<div class="row">
							<div class="col-8">
								@*<div class="form-group">
									<button id="goBack" class="btn btn-success" onclick="goBack()">Save Progress</button>
								</div>*@
							</div>
							<div class="col-4" style="float:right;">
								<div class="form-group" id="evaluasiresiko" style="color:black">
									<label>Evaluasi Risiko</label>
									<div class="form-check">
										<input class="form-check-input" type="radio" name="radbut" id="flexRadioDefault1" value="Yes" disabled="disabled">
										<label class="form-check-label" for="flexRadioDefault1">
											Perlu Ditindaklanjuti dengan Pengkajian Risiko
										</label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="radio" name="radbut" id="flexRadioDefault2" value="No" disabled="disabled">
										<label class="form-check-label" for="flexRadioDefault2">
											Tidak Perlu Ditindaklanjuti dengan Pengkajian
										</label>
									</div>
								</div>
							</div>
						</div>
					</div>                   
				</div>
				
                <div class="card">
                    <div class="card-body">
                        <div class="form-group">
                            <h4>Cancel Deviation</h4>
                            <button type="button" id="btnCancel" class="col-sm-2 btn mb-1 btn-danger form-control" ">
                                Cancel
                                <span class="fa fa-trash-o"></span>
                            </button>
                        </div>
                    </div>
                </div>
			</div>
		</div>

		<div class="form-group">
			<div class="container-fluid">
				<div class="card">
					<div class="card-body">
						<h4>REVIEWER</h4>
						<div class="form-group">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover verticle-middle" id="deviationdatatable" width="1150px" style="color:black">
                                    <thead>
                                        <tr>
                                            <th width="50px" style="text-align:center">Nama</th>
                                            <th width="50px" style="text-align:center">NIK</th>
                                            <th width="40px" style="text-align:center">Status</th>
                                            <th width="60px" style="text-align:center">Tanggal Review</th>
                                            <th style="text-align:center">Hasil Review</th>
                                            <th width="50px" style="text-align:center">Dokumen Pendukung</th>

                                        </tr>
                                    </thead>
                                    <tbody id="deviationtable" class="nowrap">
                                    </tbody>
                                </table>
                            </div>
							

							<br />
							<table class="table table-bordered table-hover verticle-middle table-responsive" id="reviewerbuktidatatable" hidden="hidden" style="white-space: nowrap">
								<thead>
									<tr>
										<th width="75px">No</th>
										<th width="100px">Nama Reviewer</th>
										<th>Nama File</th>
									</tr>
								</thead>
								<tbody id="reviewerbukti" class="nowrap">
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	   

	</div>

</body>

<script nonce="ERqZWnV5AHi1QTw3oWK9lA==">

	$(document).ready(function () {
        //load desposisi
		LoadData();
		//load reviewer
		LoadData2();
		CheckStatus();

		$('#btnCancel').click(function () {
			Cancel();
		});
	});

	//function goBack() {
	//	window.location.href = "../DataDeviasi/PendingTask"
	//}

	function Cancel() {
		Swal.fire({
            icon: 'question',
            title: 'Mohon masukan alasan untuk membatalkan penyimpangan ini?',
			input: 'textarea',
			inputAttributes: {
				autocapitalize: 'off'
			},
			showCancelButton: true,
			confirmButtonText: 'Submit',
			showLoaderOnConfirm: true,

			allowOutsideClick: () => Swal.isLoading()
		}).then((result) => {
			if (result.isConfirmed) {
				if (result.value == null || result.value == '') {
					Swal.fire({
						icon: 'error',
						title: 'Oops...',
						text: 'Alasan untuk membatalkan penyimpangan harus diisi !'
					});
				} else
					if (result.isConfirmed) {
						var REQID = @ViewBag.nomor;
						var Keterangan = result.value;
						var iduser = '@Request.RequestContext.HttpContext.Session["xUser"]';

						function CancelDeviationKoor() {
                            var dto = {
                                REQID: REQID,
                                KETERANGAN: Keterangan,
                                IDUSER: iduser
                            };

                            $.ajax({
                                url: "../Koordinator/Coor_KoorCancel",
                                type: "post",
                                dataType: "json",
                                data: JSON.stringify(dto),
                                contentType: "application/json;charset=utf-8",
                                success: function (data) {

                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Form Cancelled',
                                        showConfirmButton: false,
                                        timer: 2000
                                    }).then(() => {
                                        window.location.href = "../DataDeviasi/PendingTask"
                                    })

                                }
                                , error: function (ex) {
                                    GetError("Coor_KoorCancel", JSON.stringify(ex));
                                }
                            });
						}
						
						function NotifyCancelDevKor() {
                            var tabletype = "One";
                            var whoreceiver = "Canceled";

                            var dtx = {
                                Receiver: iduser,
                                ReqID: iduser,
                                TableType: tabletype,
                                WhoReceiver: whoreceiver
                            };

                            $.ajax({
                                type: "post",
                                url: '../Form/SendEmailInputProposal',
                                data: JSON.stringify(dtx),
                                dataType: "json",
                                contentType: "application/json;charset=utf-8",
                                success: function (data) {

                                }, error: function (ex) {
                                    GetError("EmailCancelDeviationKoor", JSON.stringify(ex));
                                }
                            });
						}

                        $.when(CancelDeviationKoor()).done(NotifyCancelDevKor());
						
					}
			}

		});
	}

	function CheckStatus() {
		var REQID = @ViewBag.nomor;

		var dto = {
			REQID: REQID
		};

		$.ajax({
			url: "../Koordinator/Koor_LoadAssignStatus",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				if (data == 'OK') {
                    window.location.href = "../DataDeviasi/PendingTask"
				}

			}, error: function (ex) {
                GetError("Koor_LoadAssignStatus", JSON.stringify(ex));
			}
		});
    }

	function ShowBukti(button) {
		event.preventDefault();

		$("#reviewerbuktidatatable").removeAttr("hidden");


		var row = $(button).closest("TR");
		var ReqID = @ViewBag.nomor;
		var reviewer = $("TD", row).eq(1).html();

		var dto = {
			REQID: ReqID,
			USER_NIK: reviewer
		}
		$('#reviewerbuktidatatable').DataTable().clear().destroy();

		$.ajax({
			url: "../Koordinator/Coor_ShowReviewerBukti",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				var trHTML = '';
				var trav = 0;
				var Count = data.length;

				if (Count == '0') {
					trHTML +=
						'<tr><td> - </td>' +
						'<td> N/A </td>' +
						'<td> N/A </td>';
				} else {
					for (trav = 0; trav < Count; trav++) {
						var no = 1;
						no = no + trav;
						trHTML +=
							'<tr><td>' + no + '</td>' +
							'<td>' + data[trav].REVIEWER_NIK + '</td>' +
                            '<td><a href="..' + data[trav].PATH_FILE_DOWNLOAD + '" download="' + data[trav].FILE_NAME_UPLOAD + '">' + data[trav].FILE_NAME_UPLOAD + '</a></td>';

					}
				}

				$('#reviewerbukti').empty();
				$('#reviewerbukti').append(trHTML);
                $('#reviewerbuktidatatable').DataTable({
                    "searching": false,
                    "paging": false,
					"info": false,
                    "ordering": false
                });

			}
			, error: function (ex) {
                GetError('Coor_ShowReviewerBukti', JSON.stringify(ex));
			}
		});
	}

	// Check Status to Determine which Row Has Action
	function LoadData2() {
		var REQID = @ViewBag.nomor;

		var dto = {
			REQID: REQID
		};
		$.ajax({
			url: "../Koordinator/Coor_LoadReviewerList",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {

				var trHTML = '';
				var trav = 0;
				var Count = data.length;
				for (trav = 0; trav < Count; trav++) {

					// WHEN REVIEWER FINISHED REVIEW / REVISE

						trHTML +=
							'<tr><td>' + data[trav].USER_NAME + '</td>' +
							'<td>' + data[trav].USER_NIK + '</td>' +
							'<td>' + data[trav].FLAG_REVIEW + '</td>' +
							'<td style="text-align:center">' + data[trav].TANGGAL + '</td>' +
							'<td>' + data[trav].KETERANGAN_REVIEW + '</td>' ;


					trHTML += '<td align="center"><button onclick="ShowBukti(this)" class="btn btn-info">View</button ></td ></tr > ';
                    $('#deviationdatatable').DataTable().destroy().clear();
					$('#deviationtable').empty();
					$('#deviationtable').append(trHTML);
                    $('#deviationdatatable').DataTable({
                        "searching": false,
						"paging": false,
						"info": false,
                        "ordering": false
                    });
				}
			}, error: function (ex) {
                GetError("LoadData2", JSON.stringify(ex));
			}
		});
	}

	function AssignPIC(button) {

		var row = $(button).closest("TR");
        var pic_nik = $("TD", row).eq(2).find("select").val();
		var due_date = $("TD", row).eq(3).find("input[type='date']").val();
        if (pic_nik == null || pic_nik == '' || due_date == null || due_date == '') {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Pelaksana dan due date wajib diisi!'
            });
            return;
        }

		var REQID = @ViewBag.nomor;

		var dtx = {
			REQID: REQID,
			UserInvolved: pic_nik
		}

		$.ajax({
			url: "../Form/CheckEmailAvailability",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dtx),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
				if (data == 'ADA') {

					var no_disposisi = $("TD", row).eq(5).find("input[type='text']").val();
					var req_id = @ViewBag.nomor;
					var curr_user = '@Request.RequestContext.HttpContext.Session["xUser"]';

					if (pic_nik == null || due_date == '') {
						Swal.fire({
							icon: 'error',
							title: 'Oops...',
							text: 'Nama Pelaksana dan Tanggal Due Date Tidak Boleh Kosong'
						});
						return;
					}

					function AssignPIC() {
						var dto = {
                            REQ_ID: req_id,
                            PIC_REMEDIAL_NIK: pic_nik,
                            DUE_DATE: due_date,
                            NO_DISPOSISI: no_disposisi,
                            CURR_USER: curr_user
						}

                        $.ajax({
                            url: "../Koordinator/Coor_AssignPIC",
                            type: "post",
                            dataType: "json",
                            data: JSON.stringify(dto),
                            contentType: "application/json;charset=utf-8",
							success: function (data) {
								function NotifyAssignT() {
                                    toastr.success("Assign PIC Berhasil!", "Tersimpan", {
                                        "closeButton": false,
                                        "debug": true,
                                        "newestOnTop": false,
                                        "progressBar": false,
                                        "positionClass": "toast-top-right",
                                        "preventDuplicates": false,
                                        "onclick": null,
                                        "showDuration": "100",
                                        "hideDuration": "1000",
                                        "timeOut": "2000",
                                        "extendedTimeOut": "1000",
                                        "showEasing": "swing",
                                        "hideEasing": "linear",
                                        "showMethod": "fadeIn",
                                        "hideMethod": "fadeOut"
                                    });
								}

								function ConditionLoad() {
                                    if (data == 'COMPLETE') {
                                        var url = "../DataDeviasi/PendingTask";
                                        $(location).attr('href', url);
                                    }
                                    else {
                                        LoadData();
                                    }
								}

								$.when(NotifyAssignT()).done(ConditionLoad());
                            }
                            , error: function (ex) {
                                GetError('Coor_AssignPIC',  JSON.stringify(ex));
                            }
                        });
					}

					function SendMailAssign() {
						var receiver = $("TD", row).eq(2).find("select").val();
						var tabletype = "One";
						var whoreceiver = "PIC after Appointed";

						var dtx = {
							Receiver: receiver,
							ReqID: REQID,
							TableType: tabletype,
							WhoReceiver: whoreceiver
						};

						$.ajax({
							type: "post",
							url: '../Form/SendEmailInputProposal',
							data: JSON.stringify(dtx),
							dataType: "json",
							contentType: "application/json;charset=utf-8",
							success: function (data) {

								toastr.success("Email Sent Successfully !", "Notification", {
									"closeButton": false,
									"debug": true,
									"newestOnTop": false,
									"progressBar": false,
									"positionClass": "toast-bottom-right",
									"preventDuplicates": false,
									"onclick": null,
									"showDuration": "200",
									"hideDuration": "1000",
									"timeOut": "1000",
									"extendedTimeOut": "1000",
									"showEasing": "swing",
									"hideEasing": "linear",
									"showMethod": "fadeIn",
									"hideMethod": "fadeOut"
								});
							}, error: function (ex) {
								GetError("Error Email Assign", JSON.stringify(ex));
							}
						});
					}

                    $.when(AssignPIC()).then(SendMailAssign());

				} else {

					Swal.fire({
						icon: 'error',
						title: 'Oops...',
						text: 'Nama Pelaksana Kosong/Email Pelaksana Tidak Tersedia'
					});
				}
			}
			, error: function (ex) {
				GetError('Check Email Availability', JSON.stringify(ex));
			}
		});
	}

	function LoadData() {

		var nomor = @ViewBag.nomor;

		function GetDisposisi() {
            var dto = {
                REQ_ID: nomor
            }

            // GET DISPOSISI TABLE FOR ASSIGNING PIC
            $.ajax({
                url: "../Koordinator/Coor_LoadDisposisiData",
                type: "post",
                dataType: "json",
                data: JSON.stringify(dto),
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    var trHTML = '';
                    var trav = 0;
                    var Count = data.length;
                    for (trav = 0; trav < Count; trav++) {
                        var no = trav + 1;

                        if (data[trav].PIC_REMEDIAL_NIK == '-' && data[trav].PIC_REMEDIAL_NAME == 'NOT YET ASSIGNED') {
                            trHTML += '<tr><td align="center">' + no + '</td>' +
                                '<td>' + data[trav].KETERANGAN_DISPOSISI + '</td>' +
                                '<td> <select id="pic' + trav + '"></td>' +
                                '<td> <input type="date" id="duedate' + trav + '"></td>' +
                                '<td align="center"> <input type="button" id="AssignPIC" value="Assign PIC" onclick=AssignPIC(this) class="btn btn-primary" /></td>' +
                                '<td hidden="hidden"><input type="text" value="' + data[trav].NO_DISPOSISI + '"</td>';

                        } else {
                            trHTML += '<tr><td align="center">' + no + '</td>' +
                                '<td>' + data[trav].KETERANGAN_DISPOSISI + '</td>' +
                                '<td>' + data[trav].PIC_REMEDIAL_NAME + '</td>' +
                                '<td>' + data[trav].DUE_DATE + '</td>' +
                                '<td align="center">* NO ACTIONS *</td>' +
                                '<td hidden="hidden"><input type="text" value="' + data[trav].NO_DISPOSISI + '"</td>';
                        }


                    }
                    $('#datatablepic').DataTable().clear().destroy();
                    $('#pictable').empty();
                    $('#pictable').append(trHTML);
                    $('#datatablepic').DataTable({
                        "searching": false,
                        "paging": false,
                        "info": false,
                        "ordering": true
                    });

                    var jumlahdisposisi = trav;

                    LoadPICList(jumlahdisposisi);
                },
                error: function (ex) {
                    GetError("Coor_LoadDisposisiData", JSON.stringify(ex));
                }
            });
		}

		function GetEvalusiResiko() {
            var dtx = {
                REQID: nomor
            }
            // GET EVALUASI RESIKO
            $.ajax({
                url: "../Koordinator/LoadEvaluasiResiko",
                type: "post",
                dataType: "json",
                data: JSON.stringify(dtx),
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    $("input[name=radbut][value=" + data[0].EVALUASI_RESIKO + "]").prop('checked', true);
                },
                error: function (ex) {
                    GetError("LoadEvaluasiResiko", JSON.stringify(ex));
                }
            });
		}

        $.when(GetDisposisi()).then(GetEvalusiResiko());
	}

	function LoadPICList(jumlahdisposisi) {
		$.ajax({
			url: "../Koordinator/Coor_LoadPICList",
			type: "post",
			dataType: "json",
			contentType: "application/json;charset=utf-8",
			success: function (data) {

				var trhtml = "";
				var trav = 0;
				var count = data.length;

				trhtml += '<option disabled class="dropdown-header" value="" selected>Select PIC</option>';
				if (count > 0) {
					for (trav = 0; trav < count; trav++) {
						trhtml +=
							'<option class="dropdown-item" value = "' + data[trav].EmpId + '">' + data[trav].EmpName + '</option>';
					}
				}
				var i = 0;

				// Populate PIC Dropdown Lists
				for (i = 0; i < jumlahdisposisi; i++) {
					$("#pic" + i).empty();
					$("#pic" + i).append(trhtml);
					$("#pic" + i).select2();
				}

			}, error: function (ex) {
                GetError("Load PIC List", JSON.stringify(ex));
			}
		});
	}

	function GetError(ErrorType, ErrorMsg) {
		var REQID = @ViewBag.nomor;
		var USERNIK = '@Request.RequestContext.HttpContext.Session["xUser"]';

		var dto = {
			REQ_ID: REQID,
			UserLogin: USERNIK,
            ErrorType: ErrorType,
            ErrorMsg: ErrorMsg
		}

		$.ajax({
			url: "../Form/LogError",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
                toastr.warning(data +" Assign ! ", "Notification", {
                    "closeButton": false,
                    "debug": true,
                    "newestOnTop": false,
                    "progressBar": false,
                    "positionClass": "toast-bottom-right",
                    "preventDuplicates": false,
                    "onclick": null,
                    "showDuration": "200",
                    "hideDuration": "1000",
                    "timeOut": "1000",
                    "extendedTimeOut": "1000",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut"
                });
			}
			, error: function (ex) {

			}
		});
	}

</script>
