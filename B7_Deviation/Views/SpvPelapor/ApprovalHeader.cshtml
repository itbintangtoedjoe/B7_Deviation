
@{
	ViewBag.Title = "ApprovalHeader";
	Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-body">
	<div class="form-group">
		<div class="container-fluid">
			<div class="row">
				<div class="col-lg-12">
					<div class="card">
						<div class="card-body">
							<div class="form-group">
								<h4 class="d-inline" style="">Laporan Penyimpangan / Potensi Penyimpangan</h4>

							</div>
							
							<div class="form-group row">
								<div class="col-md-8">
                                    <div class="form-group">
                                        <button type="button" id="btnApprove" class="col-sm-2 btn mb-1 btn-success form-control ">
                                            Approve
                                            <span class="fa fa-check-square-o"></span>
                                        </button>
                                        <button type="button" id="btnReject" class="col-sm-2 btn mb-1 btn-danger form-control">
                                            Reject
                                            <span class="fa fa-ban"></span>
                                        </button>
                                        <button type="button" id="btnUpdate" class="col-sm-2 btn mb-1 btn-info form-control">
                                            Update
                                            <span class="fa fa-ban"></span>
                                        </button>
                                    </div>
								</div>
								<div class="col-md-4">
									<div class="form-group">
										<label>Approval:</label>
										<input id="xdxdxdxd" type="text" class="form-control" readonly="readonly" value="@Request.RequestContext.HttpContext.Session["fullname"]">
									</div>
									<div class="form-group">
										<label for="txtTanggal">Tanggal:</label>
										<input class="form-control" readonly="readonly" value="@System.DateTime.Now.ToString("dd-MM-yyyy")" />
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>

	<div class="form-group">
		@Html.Partial("Approval", "Approval")

	</div>
</div>

<script>
	

	$(document).ready(function () {
		$("#btnApprove").click(function () {
			Approve();

		});

		$("#btnReject").click(function () {
			Reject();
		});

        $("#btnUpdate").click(function () {
            GetSiteName();

        });
	});

	


	function Approve() {
		var REQID = @ViewBag.nomor;
		var iduser = '@Request.RequestContext.HttpContext.Session["xUser"]';

		var dto = {

			REQID: REQID,
			IDUSER: iduser
		};

		$.ajax({
			url: "../SpvPelapor/Spv_Approve",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {

				Swal.fire({
                    icon: 'success',
					title: 'Form Approved',
                    showConfirmButton: false,
                    timer: 2000
				}).then(() => {
					$.when(
						SendEmailApproveSpvApv()
					).then(
						window.location.href = "../DataDeviasi/PendingTask"
					);
				})
			}
			, error: function (ex) {
                GetErrorSupPelH("Spv_Approve", JSON.stringify(ex));
			}
		});
	}

	function Reject() {

		Swal.fire({
            icon: 'question',
			title: 'Reason???',
			input: 'text',
			inputAttributes: {
				autocapitalize: 'off'
			},
			showCancelButton: true,
			confirmButtonText: 'Submit',
			showLoaderOnConfirm: true,

			allowOutsideClick: () => Swal.isLoading()
		}).then((result) => {

			if (result.value == null || result.value == '') {
				Swal.fire({
					icon: 'error',
					title: 'Oops...',
					text: 'Please Insert Reason!'
				});
			} else if (result.isConfirmed) {

				var REQID = @ViewBag.nomor;
				var Keterangan = result.value;
				var iduser = '@Request.RequestContext.HttpContext.Session["xUser"]';

				var dto = {
					REQID: REQID,
					KETERANGAN: Keterangan,
					IDUSER: iduser
				};

				$.ajax({
					url: "../SpvPelapor/Spv_Reject",
					type: "post",
					dataType: "json",
					data: JSON.stringify(dto),
					contentType: "application/json;charset=utf-8",
					success: function (data) {

						Swal.fire({
                            icon: 'success',
							title: 'Form Rejected',
                            showConfirmButton: false,
                            timer: 2000
						}).then(() => {
							$.when(
								SendEmailRejectSpvRjt()
							).then(
								window.location.href = "../DataDeviasi/PendingTask"
							);
						})
					}
					, error: function (ex) {
                        GetErrorSupPelH("Spv_Reject", JSON.stringify(ex));
					}
				});
			}
		});
	}

	function SendEmailRejectSpvRjt() {
		var REQID = $("#lblReq").text();
		var receiver = '@Request.RequestContext.HttpContext.Session["xUser"]';

		var tabletype = "One";
		var whoreceiver = "Proposer after Superior Reject";

		var dto = {
			Receiver: receiver,
			ReqID: REQID,
			TableType: tabletype,
			WhoReceiver: whoreceiver
		};

		$.ajax({
			type: "post",
			url: '../Form/SendEmailInputProposal',
			data: JSON.stringify(dto),
			dataType: "json",
			contentType: "application/json;charset=utf-8",
			success: function (data) {
                toastr.success("Email Sent Successfully !", "Notification", {
                    "closeButton": false,
                    "debug": true,
                    "newestOnTop": false,
                    "progressBar": false,
                    "positionClass": "toast-bottom-right",
                    "preventDuplicates": false,
                    "onclick": null,
                    "showDuration": "100",
                    "hideDuration": "1000",
                    "timeOut": "1000",
                    "extendedTimeOut": "1000",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut"
				});
			}, error: function (ex) {
                GetErrorSupPelH("SendEmailRejectSpvRjt", JSON.stringify(ex));
			}
		});
	}

	function SendEmailApproveSpvApv() {
		var REQID = $("#lblReq").text();
		var receiver = '@Request.RequestContext.HttpContext.Session["xUser"]';


		var tabletype = "More Than One";
		var whoreceiver = "Koordinator after Superior Approved";

		var dto = {
			Receiver: receiver,
			ReqID: REQID,

			TableType: tabletype,
			WhoReceiver: whoreceiver
		};

		$.ajax({
			type: "post",
			url: '../Form/SendEmailInputProposal',
			data: JSON.stringify(dto),
			dataType: "json",
			contentType: "application/json;charset=utf-8",
			success: function (data) {
                toastr.success("Email Sent Successfully !", "Notification", {
                    "closeButton": false,
                    "debug": true,
                    "newestOnTop": false,
                    "progressBar": false,
                    "positionClass": "toast-bottom-right",
                    "preventDuplicates": false,
                    "onclick": null,
                    "showDuration": "100",
                    "hideDuration": "1000",
                    "timeOut": "2000",
                    "extendedTimeOut": "1000",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut"
				});
			}, error: function (ex) {
                GetErrorSupPelH("SendEmailApproveSpvApv",JSON.stringify(ex));
			}
		});
	}

	function GetErrorSupPelH(ErrorType, ErrorMsg) {
		var REQID = @ViewBag.nomor;
		var USERNIK = '@Request.RequestContext.HttpContext.Session["xUser"]';

		var dto = {
			REQ_ID: REQID,
			UserLogin: USERNIK,
            ErrorType: ErrorType,
            ErrorMsg: ErrorMsg
		}

		$.ajax({
			url: "../Form/LogError",
			type: "post",
			dataType: "json",
			data: JSON.stringify(dto),
			contentType: "application/json;charset=utf-8",
			success: function (data) {
                toastr.warning(data +" Assign ! ", "Notification", {
                    "closeButton": false,
                    "debug": true,
                    "newestOnTop": false,
                    "progressBar": false,
                    "positionClass": "toast-bottom-right",
                    "preventDuplicates": false,
                    "onclick": null,
                    "showDuration": "200",
                    "hideDuration": "1000",
                    "timeOut": "1000",
                    "extendedTimeOut": "1000",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut"
                });
			}
			, error: function (ex) {

			}
		});
	}

</script>

